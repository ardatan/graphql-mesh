name: release
on:
  push:
    branches:
      - master
  pull_request:
jobs:
  stable:
    if: github.ref == 'refs/heads/master'
    uses: the-guild-org/shared-config/.github/workflows/release-stable.yml@main
    with:
      releaseScript: release
      nodeVersion: 18
      packageManagerVersion: modern
    secrets:
      githubToken: ${{ secrets.GITHUB_TOKEN }}
      npmToken: ${{ secrets.NODE_AUTH_TOKEN }}

  docker-build:
    # disable publishing images on master until #7283 lands (has better image that should be used instead)
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - uses: the-guild-org/shared-config/setup@main
        name: setup env
        with:
          nodeVersion: ${{matrix.node-version}}
          packageManagerVersion: modern
      - name: set up docker buildx
        uses: docker/setup-buildx-action@v3
      - name: log in to ghcr
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: bundle
        run: yarn workspaces foreach --all run bundle
      - name: bake and push
        uses: docker/bake-action@v4
        with:
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
          push: true
      - name: Comment on PR with Docker image
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          token: ${{ secrets.GH_API_TOKEN }}
          header: Docker Image
          message: |
            The Docker image for this PR is available at:
            ```
            ghcr.io/ardatan/mesh-serve:${{ github.sha }}
            ```
