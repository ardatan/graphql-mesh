# Apollo GraphOS Integration

import { Callout } from '@theguild/components'

Apollo GraphOS is a schema registry that allows you to store and manage your supergraph schemas. You
can use Hive Registry to serve your supergraph schemas stored in Apollo GraphOS, or send usage data
to Apollo GraphOS.

## Serve Supergraph from Apollo GraphOS

By default, Hive Gateway will use standard Apollo GraphOS environment variables `APOLLO_GRAPH_REF`
and `APOLLO_KEY`.

```sh
npx hive-gateway supergraph
```

But you can also provide these values using the CLI:

```sh
npx hive-gateway supergraph <graph_id>[@<variant>] --apollo-key <api_key>
```

<Callout>
  If you donâ€™t know where to find these values, please refer to the [Apollo GraphOS
  documentation](https://www.apollographql.com/docs/federation/managed-federation/setup/#4-connect-your-router-to-graphos).
</Callout>

### Configuration

You can also provide this configuration programatically by providing a configuration object, along
with other options to customize the polling behavior.

```ts filename="gateway.config.ts"
import { defineConfig } from '@graphql-hive/gateway'

export const gatewayConfig = defineConfig({
  supergraph: {
    type: 'graphos',
    /**
     * The graph ref of the managed federation graph.
     * It is composed of the graph ID and the variant (`<YOUR_GRAPH_ID>@<VARIANT>`).
     *
     * If not provided, `APOLLO_GRAPH_REF` environment variable is used.
     *
     * You can find a a graph's ref at the top of its Schema Reference page in Apollo Studio.
     */
    graphRef: '<graph_id>[@<variant>]',
    /**
     * The API key to use to authenticate with the managed federation up link.
     * It needs at least the `service:read` permission.
     *
     * If not provided, `APOLLO_KEY` environment variable will be used instead.
     *
     * [Learn how to create an API key](https://www.apollographql.com/docs/federation/v1/managed-federation/setup#4-connect-the-gateway-to-studio)
     */
    apiKey: '<api_key>',
    /**
     * The URL of the managed federation up link. When retrying after a failure, you should cycle through the default up links using this option.
     *
     * Uplinks are available in `DEFAULT_UPLINKS` constant.
     *
     * This options can also be defined using the `APOLLO_SCHEMA_CONFIG_DELIVERY_ENDPOINT` environment variable.
     * It should be a comma separated list of up links, but only the first one will be used.
     *
     * Default: 'https://uplink.api.apollographql.com/' (Apollo's managed federation up link on GCP)
     *
     * Alternative: 'https://aws.uplink.api.apollographql.com/' (Apollo's managed federation up link on AWS)
     */
    upLink?: string;
  }
})
```

## Usage Reporting and Monitoring

If you want to use GraphOS to report usage metrics, you can still provide the CLI arguments or
default environment variables as supergraph fetching.

### Configuration

Also you can provide additional configuration options to customize the usage reporting behavior.

```ts filename="gateway.config.ts"
import { defineConfig } from '@graphql-hive/gateway'

export const gatewayConfig = defineConfig({
  reporting: {
    type: 'graphos',
    /**
     * The graph ref of the managed federation graph.
     * It is composed of the graph ID and the variant (`<YOUR_GRAPH_ID>@<VARIANT>`).
     *
     * If not provided, `APOLLO_GRAPH_REF` environment variable is used.
     *
     * You can find a a graph's ref at the top of its Schema Reference page in Apollo Studio.
     */
    graphRef: '<graph_id>[@<variant>]',
    /**
     * The API key to use to authenticate with the managed federation up link.
     * It needs at least the `service:read` permission.
     *
     * If not provided, `APOLLO_KEY` environment variable will be used instead.
     *
     * [Learn how to create an API key](https://www.apollographql.com/docs/federation/v1/managed-federation/setup#4-connect-the-gateway-to-studio)
     */
    apiKey: '<api_key>',
    /**
     * Usage report endpoint
     *
     * Defaults to GraphOS endpoint (https://usage-reporting.api.apollographql.com/api/ingress/traces)
     */
    endpoint?: string;
  }
})
```
